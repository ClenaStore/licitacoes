<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Sistema de CotaÃ§Ãµes - Grupo DV</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --blue:#1e90ff;--green:#22c55e;--black:#0b0f19;
  --white:#fff;--gray:#f5f6f8;--radius:14px;
}
*{box-sizing:border-box;font-family:'Inter',sans-serif;}
body{background:var(--gray);margin:0;padding:0;color:var(--black);}
header{
  background:var(--black);color:var(--white);
  padding:15px 20px;display:flex;justify-content:space-between;align-items:center;
}
header h1{margin:0;font-size:18px;}
header .actions button{margin-left:10px;}
.container{max-width:1000px;margin:auto;padding:20px;}
.card{background:var(--white);border-radius:var(--radius);padding:20px;box-shadow:0 2px 6px rgba(0,0,0,.1);margin-bottom:20px;}
label{font-weight:600;display:block;margin-bottom:4px;}
input,select,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:var(--radius);margin-bottom:15px;}
button{padding:10px 16px;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;}
.btn-green{background:var(--green);color:var(--white);}
.btn-blue{background:var(--blue);color:var(--white);}
.btn-black{background:var(--black);color:var(--white);}
.popup{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:100;}
.popup-content{background:var(--white);padding:20px;border-radius:var(--radius);width:90%;max-width:600px;max-height:90%;overflow:auto;}
.close{float:right;font-weight:bold;color:var(--blue);cursor:pointer;}
.item-card{background:#fff;padding:10px;border:1px solid #ddd;border-radius:var(--radius);margin-bottom:10px;}
.item-card h4{margin:0 0 4px 0;}
.relative{position:relative;}
.menu-flutuante{position:absolute;background:var(--white);box-shadow:0 2px 8px rgba(0,0,0,.15);padding:8px;border-radius:var(--radius);display:none;z-index:10;width:calc(100% - 20px);}
.menu-flutuante button{display:block;width:100%;background:none;border:none;text-align:left;padding:8px;border-radius:8px;cursor:pointer;}
.menu-flutuante button:hover{background:var(--blue);color:var(--white);}
.unidade-linha{display:flex;gap:10px;align-items:center;margin-bottom:10px;position:relative;}
.unidade-linha input{flex:1;}
.unidade-linha button{padding:6px 10px;}
#popup-unidades .popup-content button{width:100%;margin-bottom:6px;}
</style>
</head>
<body>
<header>
  <h1>ðŸ“¦ CotaÃ§Ãµes - Grupo DV</h1>
  <div class="actions">
    <button class="btn-blue" onclick="abrirPopup('fornecedor')">Fornecedor</button>
    <button class="btn-green" onclick="abrirPopup('item')">Item</button>
  </div>
</header>

<div class="container">
  <div class="card">
    <h3>Nova CotaÃ§Ã£o</h3>

    <label>Nome da CotaÃ§Ã£o</label>
    <input id="nomeCotacao" placeholder="Ex: CotaÃ§Ã£o Mercearia Junho">

    <div class="relative">
      <label>Modalidade</label>
      <input id="modalidade" placeholder="Selecione a Modalidade" readonly onclick="toggleMenu('menuModalidades')">
      <div class="menu-flutuante" id="menuModalidades">
        <button onclick="setModalidade('PregÃ£o EletrÃ´nico')">PregÃ£o EletrÃ´nico</button>
        <button onclick="setModalidade('Dispensa de LicitaÃ§Ã£o')">Dispensa de LicitaÃ§Ã£o</button>
        <button onclick="setModalidade('Tomada de PreÃ§os')">Tomada de PreÃ§os</button>
        <button onclick="setModalidade('Carta Convite')">Carta Convite</button>
        <button onclick="setModalidade('Registro de PreÃ§os')">Registro de PreÃ§os</button>
        <button onclick="setModalidade('PregÃ£o Presencial')">PregÃ£o Presencial</button>
      </div>
    </div>

    <label>Local</label>
    <input id="local" placeholder="Ex: Barreiras - BA">

    <label>InstituiÃ§Ã£o / Ã“rgÃ£o</label>
    <input id="orgao" placeholder="Ex: Prefeitura de Barreiras">

    <label>Data Final</label>
    <input id="dataFinal" type="datetime-local">

    <hr>
    <label>Pesquisar Item</label>
    <input id="pesquisa" placeholder="Digite o nome do item..." oninput="filtrarItens()">
    <div id="listaItens"></div>

    <button class="btn-black" onclick="gerarPDF()">ðŸ“„ Gerar PDF</button>
  </div>
</div>

<!-- POPUP FORNECEDOR -->
<div class="popup" id="popup-fornecedor">
  <div class="popup-content">
    <span class="close" onclick="fecharPopup('fornecedor')">âœ–</span>
    <h3>Novo Fornecedor</h3>
    <label>Nome</label>
    <input id="nomeF" placeholder="Ex: MERCATTO DELÃCIA">
    <label>CPF / CNPJ</label>
    <input id="cnpjF" placeholder="00.000.000/0000-00" maxlength="18">
    <label>Telefone</label>
    <input id="telF" placeholder="(77) 99999-9999" maxlength="15">
    <button class="btn-green" onclick="salvarFornecedor()">Salvar</button>
  </div>
</div>

<!-- POPUP ITEM -->
<div class="popup" id="popup-item">
  <div class="popup-content">
    <span class="close" onclick="fecharPopup('item')">âœ–</span>
    <h3>Novo Item</h3>
    <label>Nome do Item</label>
    <input id="produto" placeholder="Ex: ARROZ 5KG">
    <label>Fornecedor</label>
    <select id="fornecedor">
      <option disabled selected value="">Selecione o fornecedor</option>
    </select>

    <label>Unidades e Valores</label>
    <div id="unidadesContainer">
      <div class="unidade-linha relative">
        <input placeholder="Unidade (Ex: PC, CX, KG)" class="unid" readonly onclick="abrirMenuUnidades(this)">
        <div class="menu-flutuante" id="menuUnidades">
          <button onclick="setUnidade('PC')">PC â€” PeÃ§a</button>
          <button onclick="setUnidade('CX')">CX â€” Caixa</button>
          <button onclick="setUnidade('FD')">FD â€” Fardo</button>
          <button onclick="setUnidade('KG')">KG â€” Quilograma</button>
          <button onclick="setUnidade('G')">G â€” Grama</button>
          <button onclick="setUnidade('UN')">UN â€” Unidade</button>
          <button onclick="setUnidade('LT')">LT â€” Litro</button>
          <button onclick="setUnidade('ML')">ML â€” Mililitro</button>
          <button onclick="setUnidade('MT')">MT â€” Metro</button>
          <button onclick="setUnidade('PCT')">PCT â€” Pacote</button>
          <button onclick="setUnidade('SC')">SC â€” Saco</button>
          <button onclick="setUnidade('DZ')">DZ â€” DÃºzia</button>
          <button onclick="setUnidade('PAR')">PAR â€” Par</button>
          <button onclick="setUnidade('JG')">JG â€” Jogo</button>
          <button onclick="setUnidade('ROLO')">ROLO â€” Rolo</button>
          <button onclick="setUnidade('PL')">PL â€” Placa</button>
          <button onclick="setUnidade('TON')">TON â€” Tonelada</button>
          <button onclick="setUnidade('SACO')">SACO â€” Saco</button>
          <button onclick="setUnidade('BALDE')">BALDE â€” Balde</button>
          <button onclick="setUnidade('MÂ²')">MÂ² â€” Metro quadrado</button>
        </div>
        <input placeholder="Valor (R$)" class="valor" oninput="mascaraValor(this)">
        <button class="btn-blue" onclick="adicionarLinha()">+</button>
      </div>
    </div>
    <button class="btn-green" onclick="salvarItem()">Salvar Item</button>
  </div>
</div>

<!-- POPUP UNIDADES -->
<div class="popup" id="popup-unidades">
  <div class="popup-content">
    <span class="close" onclick="fecharPopup('unidades')">âœ–</span>
    <h3>Escolha a Unidade</h3>
    <div id="listaUnidades"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const URL = "COLE_SEU_WEBAPP_URL_AQUI";
let fornecedores=[], todosItens=[], cotacaoItens=[], unidadesTemp=[], unidadeAtualInput=null;

/* POPUPS */
function abrirPopup(t){
  const popup=document.getElementById(`popup-${t}`);
  popup.style.display='flex';
  if(t==='item') carregarFornecedores(); // ðŸ”¹ garante atualizaÃ§Ã£o dos fornecedores
}
function fecharPopup(t){document.getElementById(`popup-${t}`).style.display='none';}

/* MENU FLUTUANTE */
function toggleMenu(id){
  const m=document.getElementById(id);
  m.style.display=m.style.display==="block"?"none":"block";
}

/* MENU DE UNIDADES */
function abrirMenuUnidades(input){
  unidadeAtualInput=input;
  const menu=document.getElementById("menuUnidades");
  menu.style.display="block";
  menu.style.top=input.offsetTop+40+"px";
  menu.style.left=input.offsetLeft+"px";
}
function setUnidade(v){
  if(unidadeAtualInput){
    unidadeAtualInput.value=v;
    document.getElementById("menuUnidades").style.display="none";
  }
}

/* MÃSCARAS */
function mascaraValor(el){
  let v=el.value.replace(/\D/g,"");
  v=(v/100).toFixed(2)+'';
  v=v.replace(".",",");
  v=v.replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1.");
  el.value="R$ "+v;
}
document.addEventListener("input", e=>{
  if(e.target.id==="cnpjF"){
    let v=e.target.value.replace(/\D/g,"");
    e.target.value=v.length<=11?v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,"$1.$2.$3-$4"):
    v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,"$1.$2.$3/$4-$5");
  }
  if(e.target.id==="telF"){
    let v=e.target.value.replace(/\D/g,"");
    e.target.value=v.replace(/(\d{2})(\d{5})(\d{4})/,"($1) $2-$3");
  }
});

/* ADICIONAR LINHAS */
function adicionarLinha(){
  const cont=document.getElementById("unidadesContainer");
  const div=document.createElement("div");
  div.className="unidade-linha relative";
  div.innerHTML=`
    <input placeholder="Unidade" class="unid" readonly onclick="abrirMenuUnidades(this)">
    <input placeholder="Valor (R$)" class="valor" oninput="mascaraValor(this)">
    <button class="btn-red" onclick="this.parentElement.remove()">-</button>`;
  cont.appendChild(div);
}

/* FORNECEDORES */
async function carregarFornecedores(){
  try{
    const r=await fetch(`${URL}?acao=listarFornecedores`);
    fornecedores=await r.json();
    const sel=document.getElementById("fornecedor");
    sel.innerHTML='<option disabled selected value="">Selecione o fornecedor</option>';
    fornecedores.forEach(f=>{
      if(f.nome) sel.innerHTML+=`<option value="${f.nome}">${f.nome}</option>`;
    });
  }catch(e){console.error("Erro ao carregar fornecedores",e);}
}

/* SALVAR FORNECEDOR */
async function salvarFornecedor(){
  const nome=document.getElementById('nomeF').value.toUpperCase();
  const cnpj=document.getElementById('cnpjF').value.toUpperCase();
  const telefone=document.getElementById('telF').value.toUpperCase();
  await fetch(URL,{method:"POST",body:JSON.stringify({acao:"salvarFornecedor",nome,cnpj,telefone})});
  alert("Fornecedor salvo!");
  ['nomeF','cnpjF','telF'].forEach(id=>document.getElementById(id).value='');
  fecharPopup('fornecedor');
  carregarFornecedores();
}

/* ITENS */
async function listarItens(){
  const r=await fetch(`${URL}?acao=listarItens`);
  todosItens=await r.json();
  renderItens(todosItens);
}
function renderItens(lista){
  const div=document.getElementById("listaItens");
  div.innerHTML=lista.map(i=>`
  <div class="item-card">
    <h4>${i.item}</h4>
    <small>Fornecedor: ${i.fornecedor}</small><br>
    <b>${i.unidade}</b> â€” <b>R$${parseFloat(i.valor).toFixed(2).replace('.',',')}</b><br>
    <button class="btn-green" onclick='abrirUnidades("${i.item}")'>Selecionar</button>
  </div>`).join("");
}
function filtrarItens(){
  const termo=document.getElementById("pesquisa").value.toUpperCase();
  const filtrado=todosItens.filter(i=>i.item.toUpperCase().includes(termo));
  renderItens(filtrado);
}

/* POPUP DE UNIDADES */
function abrirUnidades(produto){
  unidadesTemp=todosItens.filter(i=>i.item===produto);
  const div=document.getElementById("listaUnidades");
  div.innerHTML=unidadesTemp.map(u=>
    `<button class="btn-blue" onclick='selecionarUnidade(${u.id})'>
      ${u.unidade} â€” R$ ${parseFloat(u.valor).toFixed(2).replace('.',',')} (${u.fornecedor})
    </button>`).join("");
  abrirPopup('unidades');
}
function selecionarUnidade(id){
  const u=todosItens.find(x=>x.id===id);
  if(u) cotacaoItens.push(u);
  fecharPopup('unidades');
}

/* SALVAR ITEM */
async function salvarItem(){
  const produto=document.getElementById('produto').value.toUpperCase();
  const fornecedor=document.getElementById('fornecedor').value.toUpperCase();
  const linhas=document.querySelectorAll(".unidade-linha");
  let unidadesTexto="";
  linhas.forEach(l=>{
    const u=l.querySelector(".unid").value.toUpperCase();
    const v=parseFloat(l.querySelector(".valor").value.replace(/[R$\.\s]/g,"").replace(",","."))||0;
    if(u && v) unidadesTexto+=`${u}=${v}\n`;
  });
  await fetch(URL,{method:"POST",body:JSON.stringify({acao:"salvarItem",produto,fornecedor,unidades:unidadesTexto})});
  alert("Item cadastrado!");
  fecharPopup('item');
  listarItens();
}

/* PDF */
function gerarPDF(){
  const { jsPDF }=window.jspdf;
  const doc=new jsPDF();
  const nome=document.getElementById("nomeCotacao").value;
  const modalidade=document.getElementById("modalidade").value;
  const local=document.getElementById("local").value;
  const data=document.getElementById("dataFinal").value;
  const orgao=document.getElementById("orgao").value;

  doc.setFontSize(14);
  doc.text(`COTAÃ‡ÃƒO: ${nome}`,10,10);
  doc.setFontSize(10);
  doc.text(`Modalidade: ${modalidade}`,10,18);
  doc.text(`InstituiÃ§Ã£o: ${orgao}`,10,24);
  doc.text(`Local: ${local}`,10,30);
  doc.text(`Data Final: ${data}`,10,36);

  let y=46;
  cotacaoItens.forEach(i=>{
    doc.text(`${i.item} - ${i.fornecedor} | ${i.unidade} | R$ ${parseFloat(i.valor).toFixed(2).replace('.',',')}`,10,y);
    y+=6;
  });
  doc.save(`Cotacao_${nome}.pdf`);
}

/* INICIALIZAÃ‡ÃƒO */
carregarFornecedores();
listarItens();
</script>
</body>
</html>
